#!/bin/bash
# pre-commit hook - blocks commits containing OpenAI API key patterns
# Enable: git config core.hooksPath .githooks

set -euo pipefail

RED='\033[0;31m'
NC='\033[0m'

# Pattern: sk-proj- followed by 40+ alphanumeric chars (real keys)
# Excludes documentation patterns like "sk-proj-..." or "sk-proj-*"
KEY_PATTERN='sk-proj-[a-zA-Z0-9_-]{40,}'

# Use ripgrep if available, fallback to grep
if command -v rg &>/dev/null; then
    MATCH=$(git diff --cached --diff-filter=ACMR | rg -o "$KEY_PATTERN" 2>/dev/null || true)
else
    MATCH=$(git diff --cached --diff-filter=ACMR | grep -oE "$KEY_PATTERN" 2>/dev/null || true)
fi

if [[ -n "$MATCH" ]]; then
    echo ""
    echo -e "${RED}COMMIT BLOCKED: Possible OpenAI API key detected in staged changes${NC}"
    echo ""
    echo "Pattern matched: $KEY_PATTERN"
    echo ""
    echo "Remediation:"
    echo "  1. Remove the key from your files"
    echo "  2. Store keys in .env.local (already gitignored)"
    echo "  3. Use: export OPENAI_API_KEY=\"...\" in your shell"
    echo ""
    exit 1
fi

exit 0
